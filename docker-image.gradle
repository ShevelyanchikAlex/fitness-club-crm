def versionNumber = {
    ByteArrayOutputStream stdoutCommitNumber = new ByteArrayOutputStream()
    ByteArrayOutputStream stdoutCommitHash = new ByteArrayOutputStream()
    ByteArrayOutputStream stdoutBranchName = new ByteArrayOutputStream()

    exec {
        commandLine("git", "rev-list", "HEAD", "--count")
        standardOutput = stdoutCommitNumber
    }

    exec {
        commandLine("git", "rev-parse", "--short", "HEAD")
        standardOutput = stdoutCommitHash
    }

    exec {
        commandLine("git", "rev-parse", "--abbrev-ref", "HEAD")
        standardOutput = stdoutBranchName
    }

    String appVersion =
            stdoutCommitNumber.toString().trim() +
                    "-" + stdoutCommitHash.toString().trim() +
                    "-" + stdoutBranchName.toString().trim()

    return appVersion.toLowerCase()
}


project.ext.loginDocker = {
    tasks.register('loginDocker') {
        group = 'build'
        dependsOn build

        doLast {
            exec {
                commandLine("echo", "dckr_pat_9KXVvvHCFtYyOdNxc4uy518pQHA", "|", "docker", "login", "-u", "shevelyanchik", "--password-stdin")
            }
        }
    }
}

project.ext.logoutDocker = {
    tasks.register('logoutDocker') {
        group = 'build'
        dependsOn build

        doLast {
            exec {
                commandLine("docker", "logout")
            }
        }
    }
}

project.ext.buildDockerImage = { imageName ->
    tasks.register('buildDockerImage') {
        group = 'build'
        dependsOn build

        String imageNameWithTag = "$imageName:${versionNumber()}"

        doLast {
            exec {
                commandLine("docker", "build", "-t", imageNameWithTag, ".")
            }
        }
    }
}

project.ext.pushDockerImage = { imageName ->
    tasks.register('pushDockerImage') {
        group = 'build'
        dependsOn build

        String imageNameWithTag = "$imageName:${versionNumber()}"

        doLast {
            exec {
                commandLine("docker", "push", imageNameWithTag)
            }
        }
    }
}